@{
	ViewBag.Title = "Gestión de Clientes";
}

<h2>Gestión de Clientes</h2>

<button id="btnNuevoCliente" class="btn btn-primary mb-3" data-toggle="modal" data-target="#modalCliente">
	<i class="fas fa-plus"></i> Nuevo Cliente
</button>

<table id="tablaClientes" class="table table-striped table-bordered">
	<thead>
		<tr>
			<th>ID</th>
			<th>Nombre</th>
			<th>Email</th>
			<th>Teléfono</th>
			<th>Ciudad</th>
			<th>Acciones</th>
		</tr>
	</thead>
	<tbody>
		<!-- Los datos se cargarán dinámicamente con jQuery -->
	</tbody>
</table>

<!-- Modal para Crear/Editar Cliente -->
<div class="modal fade" id="modalCliente" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="modalClienteLabel">Nuevo Cliente</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="formCliente">
					<input type="hidden" id="IdCliente" name="IdCliente" value="0" />
					<div class="form-row">
						<div class="form-group col-md-4">
							<label for="TipoIdentificacion">Tipo Identificación</label>
							<select class="form-control" id="TipoIdentificacion" name="TipoIdentificacion" required>
								<option value="">Seleccione...</option>
								<option value="CC">Cédula de Ciudadanía</option>
								<option value="CE">Cédula de Extranjería</option>
								<option value="TI">Tarjeta de Identidad</option>
								<option value="PP">Pasaporte</option>
								<option value="DNI">Documento Nacional de Identidad</option>
							</select>
						</div>
						<div class="form-group col-md-8">
							<label for="NumeroIdentificacion">Número Identificación</label>
							<input type="text" class="form-control" id="NumeroIdentificacion" name="NumeroIdentificacion" required>
						</div>
					</div>
					<div class="form-group">
						<label for="Nombres">Nombres Completos</label>
						<input type="text" class="form-control" id="Nombres" name="Nombres" required>
					</div>
					<div class="form-row">
						<div class="form-group col-md-6">
							<label for="Email">Email</label>
							<input type="email" class="form-control" id="Email" name="Email" required>
						</div>
						<div class="form-group col-md-6">
							<label for="Telefono">Teléfono</label>
							<input type="text" class="form-control" id="Telefono" name="Telefono" required>
						</div>
					</div>
					<div class="form-group">
						<label for="Direccion">Dirección</label>
						<input type="text" class="form-control" id="Direccion" name="Direccion" required>
					</div>
					<div class="form-row">
						<div class="form-group col-md-6">
							<label for="Ciudad">Ciudad</label>
							<input type="text" class="form-control" id="Ciudad" name="Ciudad" required>
						</div>
						<div class="form-group col-md-6">
							<label for="Pais">País</label>
							<select class="form-control" id="Pais" name="Pais" required>
								<option value="">Seleccione...</option>
								<option value="CO">Colombia</option>
								<option value="ES">España</option>
								<option value="MX">México</option>
								<option value="AR">Argentina</option>
								<option value="FR">Francia</option>
								<option value="US">Estados Unidos</option>
							</select>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" id="btnCancelarCliente" data-dismiss="modal">Cancelar</button>
				<button type="button" class="btn btn-primary" id="btnGuardarCliente">Guardar</button>
			</div>
		</div>
	</div>
</div>

<!-- Modal de Confirmación para Eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Confirmar Eliminación</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				¿Está seguro de que desea eliminar este cliente?
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
				<button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap4.min.css">


	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
	<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap4.min.js"></script>

	<script src="~/Scripts/Global.js"></script>
	<script>
		// Variable global para almacenar el ID del cliente a eliminar
		var clienteIdAEliminar = null;

		$(document).ready(function () {
			// Inicializar DataTable
			var table = $('#tablaClientes').DataTable({
				"ajax": {
					"url": urlApiRest + "Customers",
					"dataSrc": ""
				},
				"columns": [
					{ "data": "idCliente" },
					{ "data": "nombres" },
					{ "data": "email" },
					{ "data": "telefono" },
					{ "data": "ciudad" },
					{
						"data": null,
						"render": function (data, type, row) {
							return `
								<button class="btn btn-sm btn-warning btn-editar" data-id="${data.idCliente}">
									<i class="fas fa-edit"></i> Editar
								</button>
								<button class="btn btn-sm btn-danger btn-eliminar" data-id="${data.idCliente}">
									<i class="fas fa-trash"></i> Eliminar
								</button>
							`;
						}
					}
				],
				"language": {
					"url": "//cdn.datatables.net/plug-ins/1.11.3/i18n/es_es.json"
				}
			});

			// Evento para abrir modal de nuevo cliente
			$('#btnNuevoCliente').click(function () {
				$('#modalClienteLabel').text('Nuevo Cliente');
				$('#formCliente')[0].reset();
				$('#IdCliente').val('0');
				$('#modalCliente').modal('show');
			});

			// Evento para guardar cliente (crear o editar)
			$('#btnGuardarCliente').click(function () {
				if ($('#formCliente')[0].checkValidity()) {
					var idCLiente = $('#IdCliente').val();
					var cliente;
					if (idCLiente > 0) {
						cliente = {
							idCliente: parseInt(idCLiente),
							tipoIdentificacion: $('#TipoIdentificacion').val(),
							numeroIdentificacion: $('#NumeroIdentificacion').val(),
							nombres: $('#Nombres').val(),
							email: $('#Email').val(),
							telefono: $('#Telefono').val(),
							direccion: $('#Direccion').val(),
							ciudad: $('#Ciudad').val(),
							pais: $('#Pais').val()
						};
					} else {
						cliente = {
							tipoIdentificacion: $('#TipoIdentificacion').val(),
							numeroIdentificacion: $('#NumeroIdentificacion').val(),
							nombres: $('#Nombres').val(),
							email: $('#Email').val(),
							telefono: $('#Telefono').val(),
							direccion: $('#Direccion').val(),
							ciudad: $('#Ciudad').val(),
							pais: $('#Pais').val()
						};
					}

					const _url = urlApiRest + "Customers" + (idCLiente > 0 ? "/Update" : "");
					console.log(cliente);
					debugger;


					$.ajax({
						url: _url,
						type: "POST",
						data: JSON.stringify(cliente),
						contentType: "application/json; charset=utf-8",
						success: function () {
							$('#modalCliente').modal('hide');
							$('#btnCancelarCliente').click();
							table.ajax.reload();
							alert('Cliente guardado correctamente');
						},
						error: function (xhr, status, error) {
							alert('Error al guardar el cliente: ' + error);
						}
					});
				} else {
					$('#formCliente')[0].reportValidity();
				}
			});

			// Evento para editar cliente
			$('#tablaClientes').on('click', '.btn-editar', function () {
				const id = $(this).data('id');

				$.ajax({
					url: urlApiRest + "Customers/" + id,
					type: 'GET',
					success: function (cliente) {
						$('#modalClienteLabel').text('Editar Cliente');
						$('#IdCliente').val(cliente.idCliente);
						$('#TipoIdentificacion').val(cliente.tipoIdentificacion);
						$('#NumeroIdentificacion').val(cliente.numeroIdentificacion);
						$('#Nombres').val(cliente.nombres);
						$('#Email').val(cliente.email);
						$('#Telefono').val(cliente.telefono);
						$('#Direccion').val(cliente.direccion);
						$('#Ciudad').val(cliente.ciudad);
						$('#Pais').val(cliente.pais);
						$('#modalCliente').modal('show');
					},
					error: function (xhr, status, error) {
						alert('Error al cargar el cliente: ' + error);
					}
				});
			});

			// Evento para eliminar cliente
			$('#tablaClientes').on('click', '.btn-eliminar', function () {

				clienteIdAEliminar = $(this).data('id');
				$('#modalEliminar').modal('show');
			});

			// Confirmar eliminación
			$('#btnConfirmarEliminar').click(function () {
				if (clienteIdAEliminar) {

					const _url = urlApiRest + "Customers/Delete/" + clienteIdAEliminar;
					$.ajax({
						url: _url,
						type: 'POST',
						data: "",
						contentType: "application/json; charset=utf-8",
						success: function () {
							$('#modalEliminar').modal('hide');
							table.ajax.reload();
							alert('Cliente eliminado correctamente');
						},
						error: function (xhr, status, error) {
							alert('Error al eliminar el cliente: ' + error);
						}
					});
					debugger;
				}
			});
		});
	</script>

}

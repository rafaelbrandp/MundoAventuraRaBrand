<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gestión de Productos</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap4.min.css">
	<style>
		.action-buttons .btn {
			margin-right: 5px;
		}

		.table thead th {
			border-top: none;
		}

		.card {
			border: none;
			box-shadow: 0 0 15px rgba(0,0,0,0.1);
		}

		.page-title {
			color: #2c3e50;
			font-weight: 600;
		}

		.btn-primary {
			background-color: #3498db;
			border-color: #3498db;
		}

			.btn-primary:hover {
				background-color: #2980b9;
				border-color: #2980b9;
			}

		.currency-input {
			text-align: right;
		}
	</style>
</head>
<body>
	<div class="container-fluid py-4">
		<div class="card">
			<div class="card-body">
				<div class="d-flex justify-content-between align-items-center mb-4">
					<h2 class="page-title">Gestión de Productos</h2>
					<button id="btnNuevoProducto" class="btn btn-primary" data-toggle="modal" data-target="#modalProducto">
						<i class="fas fa-plus"></i> Nuevo Producto
					</button>
				</div>

				<div class="table-responsive">
					<table id="tablaProductos" class="table table-hover table-striped">
						<thead class="thead-dark">
							<tr>
								<th>ID</th>
								<th>Nombre</th>
								<th>Precio Unitario</th>
								<th>Impuesto (%)</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody>
							<!-- Los datos se cargarán dinámicamente con jQuery -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal para Crear/Editar Producto -->
	<div class="modal fade" id="modalProducto" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title" id="modalProductoLabel">Nuevo Producto</h5>
					<button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<form id="formProducto">
						<input type="hidden" id="IdProducto" name="IdProducto" value="0" />
						<div class="form-group">
							<label for="Nombre">Nombre del Producto</label>
							<input type="text" class="form-control" id="Nombre" name="Nombre" required>
						</div>
						<div class="form-row">
							<div class="form-group col-md-6">
								<label for="PrecioUnitario">Precio Unitario</label>
								<div class="input-group">
									<div class="input-group-prepend">
										<span class="input-group-text">$</span>
									</div>
									<input type="number" step="0.01" class="form-control currency-input" id="PrecioUnitario" name="PrecioUnitario" required>
								</div>
							</div>
							<div class="form-group col-md-6">
								<label for="Impuesto">Impuesto (%)</label>
								<input type="number" step="0.01" class="form-control" id="Impuesto" name="Impuesto" required>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" id="btnCancelarProducto" data-dismiss="modal">Cancelar</button>
					<button type="button" class="btn btn-primary" id="btnGuardarProducto">Guardar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal de Confirmación para Eliminar -->
	<div class="modal fade" id="modalEliminar" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header bg-danger text-white">
					<h5 class="modal-title">Confirmar Eliminación</h5>
					<button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					¿Está seguro de que desea eliminar este producto?
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
					<button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
				</div>
			</div>
		</div>
	</div>

	@section Scripts {
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap4.min.css">

		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
		<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
		<script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap4.min.js"></script>

		<script src="~/Scripts/Global.js"></script>
		<script>
			// Variable global para almacenar el ID del producto a eliminar
			var productoIdAEliminar = null;
			// URL base de la API
			var apiUrl = urlApiRest + "Products";

			$(document).ready(function () {
				// Inicializar DataTable
				var table = $('#tablaProductos').DataTable({
					"ajax": {
						"url": apiUrl,
						"dataSrc": ""
					},
					"columns": [
						{ "data": "idProducto" },
						{ "data": "nombre" },
						{
							"data": "precioUnitario",
							"render": function (data, type, row) {
								return '$' + parseFloat(data).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
							}
						},
						{
							"data": "impuesto",
							"render": function (data, type, row) {
								return parseFloat(data).toFixed(2) + '%';
							}
						},
						{
							"data": null,
							"render": function (data, type, row) {
								return `
											<div class="action-buttons">
												<button class="btn btn-sm btn-warning btn-editar" data-id="${data.idProducto}">
													<i class="fas fa-edit"></i> Editar
												</button>
												<button class="btn btn-sm btn-danger btn-eliminar" data-id="${data.idProducto}">
													<i class="fas fa-trash"></i> Eliminar
												</button>
											</div>
										`;
							}
						}
					],
					"language": {
						"url": "//cdn.datatables.net/plug-ins/1.11.3/i18n/es_es.json"
					}
				});

				// Evento para abrir modal de nuevo producto
				$('#btnNuevoProducto').click(function () {
					$('#modalProductoLabel').text('Nuevo Producto');
					$('#formProducto')[0].reset();
					$('#IdProducto').val('0');
					$('#modalProducto').modal('show');
				});

				// Evento para guardar producto (crear o editar)
				$('#btnGuardarProducto').click(function () {
					if ($('#formProducto')[0].checkValidity()) {
						var idProducto = $('#IdProducto').val();
						var producto;

						if (idProducto > 0) {
							producto = {
								idProducto: parseInt(idProducto),
								nombre: $('#Nombre').val(),
								precioUnitario: parseFloat($('#PrecioUnitario').val()),
								impuesto: parseFloat($('#Impuesto').val())
							};
						} else {
							producto = {
								nombre: $('#Nombre').val(),
								precioUnitario: parseFloat($('#PrecioUnitario').val()),
								impuesto: parseFloat($('#Impuesto').val())
							};
						}

						const _url = idProducto > 0 ? apiUrl + "/Update" : apiUrl;

						$.ajax({
							url: _url,
							type: "POST",
							data: JSON.stringify(producto),
							contentType: "application/json; charset=utf-8",
							success: function () {
								$('#modalProducto').modal('hide');
								$('#btnCancelarProducto').click();
								table.ajax.reload();
								alert('Producto guardado correctamente');
							},
							error: function (xhr, status, error) {
								alert('Error al guardar el producto: ' + error);
							}
						});
					} else {
						$('#formProducto')[0].reportValidity();
					}
				});

				// Evento para editar producto
				$('#tablaProductos').on('click', '.btn-editar', function () {
					const id = $(this).data('id');

					$.ajax({
						url: apiUrl + "/" + id,
						type: 'GET',
						success: function (producto) {
							$('#modalProductoLabel').text('Editar Producto');
							$('#IdProducto').val(producto.idProducto);
							$('#Nombre').val(producto.nombre);
							$('#PrecioUnitario').val(producto.precioUnitario);
							$('#Impuesto').val(producto.impuesto);
							$('#modalProducto').modal('show');
						},
						error: function (xhr, status, error) {
							alert('Error al cargar el producto: ' + error);
						}
					});
				});

				// Evento para eliminar producto
				$('#tablaProductos').on('click', '.btn-eliminar', function () {
					productoIdAEliminar = $(this).data('id');
					$('#modalEliminar').modal('show');
				});

				// Confirmar eliminación
				$('#btnConfirmarEliminar').click(function () {
					if (productoIdAEliminar) {
						const _url = apiUrl + "/Delete/" + productoIdAEliminar;
						$.ajax({
							url: _url,
							type: 'POST',
							contentType: "application/json; charset=utf-8",
							success: function () {
								$('#modalEliminar').modal('hide');
								table.ajax.reload();
								alert('Producto eliminado correctamente');
							},
							error: function (xhr, status, error) {
								alert('Error al eliminar el producto: ' + error);
							}
						});
					}
				});
			});
		</script>
	}
	</body>
</html>
